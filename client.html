<!DOCTYPE html>
<meta charset="utf-8" />
<title>RT Taskboard – Minimal Client</title>
<body>
  <h1>RT Taskboard – Minimal Client</h1>

  <div>
    <label
      >Board ID:
      <input id="boardId" value="alpha" />
    </label>
    <button id="connectBtn">Connect + Join</button>
  </div>

  <div style="margin-top: 12px">
    <input id="title" placeholder="Task title" />
    <button id="createBtn">Create</button>
  </div>

  <h3>Tasks</h3>
  <ul id="list"></ul>

  <h3>Log</h3>
  <pre
    id="log"
    style="
      height: 160px;
      overflow: auto;
      background: #111;
      color: #0f0;
      padding: 8px;
    "
  ></pre>

  <script>
    let ws = null;
    let currentBoard = null;
    let tasks = new Map();

    function log(...a) {
      const p = document.getElementById("log");
      p.textContent += a.join(" ") + "\n";
      p.scrollTop = p.scrollHeight;
    }
    function render() {
      const ul = document.getElementById("list");
      ul.innerHTML = "";
      for (const t of tasks.values()) {
        const li = document.createElement("li");
        li.textContent =
          (t.done ? "[x] " : "[ ] ") + t.title + " (" + t.id + ") ";
        const toggle = document.createElement("button");
        toggle.textContent = "toggle";
        toggle.onclick = () =>
          ws.send(
            JSON.stringify({
              type: "update",
              boardId: currentBoard,
              task: { id: t.id, done: !t.done },
            })
          );
        const del = document.createElement("button");
        del.textContent = "delete";
        del.onclick = () =>
          ws.send(
            JSON.stringify({
              type: "delete",
              boardId: currentBoard,
              taskId: t.id,
            })
          );
        li.append(" ", toggle, " ", del);
        ul.appendChild(li);
      }
    }

    document.getElementById("connectBtn").onclick = () => {
      if (ws) {
        try {
          ws.close();
        } catch {}
        ws = null;
      }
      currentBoard = document.getElementById("boardId").value.trim() || "alpha";
      ws = new WebSocket("ws://127.0.0.1:3002/ws");
      ws.onopen = () => {
        log("OPEN");
        ws.send(JSON.stringify({ type: "join", boardId: currentBoard }));
      };
      ws.onmessage = (e) => {
        try {
          const m = JSON.parse(e.data);
          if (m.type === "hello") log("HELLO");
          if (m.type === "snapshot") {
            tasks = new Map(m.tasks.map((t) => [t.id, t]));
            render();
          }
          if (m.type === "created") {
            tasks.set(m.task.id, m.task);
            render();
          }
          if (m.type === "updated") {
            tasks.set(m.task.id, m.task);
            render();
          }
          if (m.type === "deleted") {
            tasks.delete(m.taskId);
            render();
          }
          if (m.type === "error") log("ERROR", m.error);
        } catch (err) {
          log("PARSE_ERR", err);
        }
      };
      ws.onclose = (ev) => log("CLOSE", ev.code);
      ws.onerror = (e) => log("ERR", e?.message || "socket error");
    };

    document.getElementById("createBtn").onclick = () => {
      const title = document.getElementById("title").value.trim();
      if (!title) return;
      if (!ws || ws.readyState !== 1) return log("Not connected");
      ws.send(
        JSON.stringify({
          type: "create",
          boardId: currentBoard,
          task: { title },
        })
      );
      document.getElementById("title").value = "";
    };
  </script>
</body>
